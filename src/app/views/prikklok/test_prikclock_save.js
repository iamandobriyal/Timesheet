

var PROJECTS$ = [{
    "_id": "5c5c438a2815a8047e1addf4", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341"], "sub_tasks": [{ "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5c47742815a8047e1addf5", "task_name": "Meeting", "description": "df", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "status": "started", "createdAt": "2019-02-07T14:57:56.899Z" },
    { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5c4a7d2815a8047e1addfb", "task_name": "coding", "description": "Beetje code enzooo", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "status": "waiting", "createdAt": "2019-02-07T15:10:53.604Z" },
    { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5c4b2c2815a8047e1addfd", "task_name": "dumpy", "description": "df", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "createdAt": "2019-02-07T15:13:48.088Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5dce3c681c5b00f789b8ca", "task_name": "bier", "description": "lalal", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "createdAt": "2019-02-08T18:45:16.832Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c8a98c0bd6e6802ede74cab", "task_name": "test", "description": "set", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "status": "stopped", "createdAt": "2019-03-14T18:09:04.944Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c8a98d3bd6e6802ede74cac", "task_name": "er", "description": "eeeeeee", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "createdAt": "2019-03-14T18:09:23.193Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c8acb0d3767000397179ed2", "task_name": "iklli", "description": "liil", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c438a2815a8047e1addf4", "createdAt": "2019-03-14T21:43:41.736Z" }], "project_name": "Muino", "description": "De muino website", "project_customer": "muino.nl", "creater_id": "5c167160f2ea4c02a7bd8341", "status": "active", "createdAt": "2019-02-07T14:41:14.910Z"
}, { "_id": "5c5c48bb2815a8047e1addfa", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341"], "sub_tasks": [{ "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5c4eee2815a8047e1addff", "task_name": "WAZAAARRRRRR", "description": "joepie", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c48bb2815a8047e1addfa", "status": "stopped", "createdAt": "2019-02-07T15:29:50.044Z" }], "project_name": "muino.nl", "description": "muino website developtmenet", "project_customer": "Muino", "creater_id": "5c167160f2ea4c02a7bd8341", "status": "active", "createdAt": "2019-02-07T15:03:23.141Z" }, { "_id": "5c5c4ac12815a8047e1addfc", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341"], "sub_tasks": [{ "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c5c4edc2815a8047e1addfe", "task_name": "df", "description": "df", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c5c4ac12815a8047e1addfc", "createdAt": "2019-02-07T15:29:32.538Z" }], "project_name": "bart", "description": "dojfaojo", "project_customer": "brampapat", "creater_id": "5c167160f2ea4c02a7bd8341", "status": "active", "createdAt": "2019-02-07T15:12:01.098Z" }, { "_id": "5c8ac7db3767000397179ed0", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341", "5bf853ec74447b001aab956b"], "sub_tasks": [{ "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5c8ac9133767000397179ed1", "task_name": "test", "description": "er", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5c8ac7db3767000397179ed0", "status": "started", "createdAt": "2019-03-14T21:35:15.529Z" }], "project_name": "tyhth", "description": "ththththtafdasfdawfa", "project_customer": "thth", "creater_id": "5c167160f2ea4c02a7bd8341", "createdAt": "2019-03-14T21:30:03.053Z" }, { "_id": "5ced954c6f6f1e006dbf9565", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341", "5c167160f2ea4c02a7bd8341"], "sub_tasks": [{ "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5ced955f6f6f1e006dbf9566", "task_name": "Meeting", "description": "A meeting with the guys", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5ced954c6f6f1e006dbf9565", "status": "started", "createdAt": "2019-05-28T20:09:03.843Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5ced957e6f6f1e006dbf9567", "task_name": "Building prikklok", "description": " This is the part of time accounting building part thing.", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5ced954c6f6f1e006dbf9565", "status": "started", "createdAt": "2019-05-28T20:09:34.688Z" }, { "assigned": [], "clock_out_events": [], "sub_tasks": [], "_id": "5ced95b46f6f1e006dbf9568", "task_name": "System design", "description": "Designing the backend of the system", "creater_id": "5c167160f2ea4c02a7bd8341", "parrent": "5ced954c6f6f1e006dbf9565", "status": "started", "createdAt": "2019-05-28T20:10:28.782Z" }], "project_name": "muino", "description": "The project of projects", "project_customer": "An awsome project", "creater_id": "5c167160f2ea4c02a7bd8341", "status": "active", "createdAt": "2019-05-28T20:08:44.360Z" }, { "_id": "5d1a648e7b050e3e70c74eec", "private": true, "assigned": ["5c167160f2ea4c02a7bd8341", "5c167160f2ea4c02a7bd8341"], "sub_tasks": [], "project_name": "bier", "project_customer": "muino", "creater_id": "5c167160f2ea4c02a7bd8341", "status": "active", "createdAt": "2019-07-01T19:52:46.546Z" }];


var event_list = [
    {
        "_id": "5d29e8dca41a08007cc1c3ca",
        "user_id": "5c167160f2ea4c02a7bd8341",
        "task_id": "5c5c4eee2815a8047e1addff",
        "time_start": "2019-07-14T22:00:00.000Z",
        "time_stop": "2019-07-15T20:00:00.000Z",
        "groupid": "f890d563-3c6d-44c8-af66-fad439b8e42d",
    }
];

function get_task_id(task) {
    // * return task id from a task with project

    for (let i in this.PROJECTS$) {
        for (let j in this.PROJECTS$[i].sub_tasks) {
            if (this.PROJECTS$[i].sub_tasks[j].task_name == task) {
                return this.PROJECTS$[i].sub_tasks[j]._id;
            }
        }
    }
}// end task


const save_data = [
    {
        "comment": "1223 1223", // comment in events update
        "mo": 22,
        "tu": 23, // veranderd
        "task_id": "5c5c4eee2815a8047e1addff",
        "task_name": "WAZAAARRRRRR",
        "project_id": "5c5c48bb2815a8047e1addfa",
        "project_name": "muino.nl",
        "project_list": [
            "Muino",
            "muino.nl",
            "bart",
            "tyhth",
            "muino",
            "bier"
        ],
        "task_list": [
            "WAZAAARRRRRR"
        ],
        "events": [
            {
                "_id": "5d29e8dca41a08007cc1c3ca",
                "user_id": "5c167160f2ea4c02a7bd8341",
                "task_id": "5c5c4eee2815a8047e1addff",
                "time_start": "2019-07-14T22:00:00.000Z",
                "time_stop": "2019-07-15T20:00:00.000Z",
                "comment": "1223 1223",
                "logged": {
                    "day": "mo",
                    "mo": 22,
                    "hours": 22,

                },
                "groupid": "fb11b0c3-093e-4d84-bc5f-2b31fcc5cc49"
            },
            {
                "_id": "5d29e8dca41a08007cc1c3c1",
                "user_id": "5c167160f2ea4c02a7bd8341",
                "task_id": "5c5c4eee2815a8047e1addff",
                "time_start": "2019-07-15T22:00:00.000Z",
                "time_stop": "2019-07-16T20:00:00.000Z",
                "logged": {
                    "day": "tu",
                    "tu": 22,
                    "hours": 22
                },
                "groupid": "fb11b0c3-093e-4d84-bc5f-2b31fcc5cc49"
            }
        ],
        "total": 45
    },
    {
        "comment": "321",// comment update 
        "tu": 3,
        "task_id": "5c5c4eee2815a8047e1addff",
        "task_name": "WAZAAARRRRRR",
        "project_id": "5c5c48bb2815a8047e1addfa",
        "project_name": "muino.nl",
        "project_list": [
            "Muino",
            "muino.nl",
            "bart",
            "tyhth",
            "muino",
            "bier"
        ],
        "task_list": [
            "WAZAAARRRRRR"
        ],
        "events": [
            {
                "_id": "5d2a44be3d57d501217c604d",
                "user_id": "5c167160f2ea4c02a7bd8341",
                "task_id": "5c5c4eee2815a8047e1addff",
                "time_start": "2019-07-15T22:00:00.000Z",
                "time_stop": "2019-07-16T01:00:00.000Z",
                "logged": {
                    "day": "tu",
                    "tu": 3,
                    "hours": 3
                },
                "groupid": "0d8df2d4-f21a-4c23-a670-7d6fe3b618d7"
            }
        ],
        "total": 3
    },
    {

        "tu": 2, 
        "task_id": "5c5c4eee2815a8047e1addff",
        "task_name": "test",
        "project_id": "5c8ac7db3767000397179ed0",
        "project_name": "tyhth",
        "project_list": [
            "Muino",
            "muino.nl",
            "bart",
            "tyhth",
            "muino",
            "bier"
        ],
        "task_list": [
            "test"
        ],
        "events": [
            {
                "_id": "5d2a44e93d57d501217c604e",
                "user_id": "5c167160f2ea4c02a7bd8341",
                "task_id": "5c8ac9133767000397179ed1",
                "time_start": "2019-07-15T22:00:00.000Z",
                "time_stop": "2019-07-16T00:00:00.000Z",
                "logged": {
                    "day": "tu",
                    "tu": 2,
                    "hours": 2
                },
                "groupid": "6d04f3d1-4206-4d61-87ea-c12143cdf4e3"
            }
        ],
        "total": 2
    },
    {
        "comment": "Hier biertje", // nieuwe event
        "project_list": [
            "Muino",
            "muino.nl",
            "bart",
            "tyhth",
            "muino",
            "bier"
        ],
        "project_name": "tyhth",
        "task_list": [
            "test"
        ],
        "task_name": "test",
        "sa": 3,
        "total": 3
    }
];


const week = {
    mo: new Date(),
    tu: new Date(),
    we: new Date(),
    th: new Date(),
    fr: new Date(),
    sa: new Date(),
    su: new Date()
};



console.log("Test saving part");
// console.log(data[3]);

// TODO handle dublicates
// TODO handle excisting objects
// TODO handle removing objects

function addhoures(date_, h) {
    // h = Math.ceil(h)
    if (typeof (date_) === "string") {
        date_ = new Date(date_);
    }
    if (h > 0 && h < 25) { return date_.getTime() + (h * 60 * 60 * 1000); }
    if (h > 24) { return date_.getTime() + (h % 24 * 60 * 60 * 1000); }// modulo 24 so there is always something //TODO fix this not dirty


    //! when zero gettime is in place

    return date_.getTime(); // TODO make some test somewhere that checks if date is correct 
}


const weekdays = ['mo', 'tu', 'we', 'th', 'fr', 'sa', 'su'];
const user_id = "5c167160f2ea4c02a7bd8341";
const new_houres = (time_start, time_stop) => ((new Date(time_stop).getTime() - new Date(time_start).getTime()) / 3600000); // div by 3600k to make houres 
let create_events_send = [];
let update_events_send = [];
//------------------------------------------------------------------------------------------------------------------------------------------------------------



// let i = 0;

// this.data.map(event=>({...event})).filter(element=>( weekdays.map(day=>(element[day])) ))
const checkTaskID = (element, event) => (element.task_id !== event.task_id);
const checkComment = (element, event) => ((element.comment) && (element.comment !== event.comment));
const checkHoures = (element, event, day) => (element[day] !== event.logged[day]);

let events = [];
let temp = save_data.map(event => ({ ...event }))
    .filter(element => {
        (weekdays.map((day) => {
            let inArray = false;
            // if the day is in object and event already excisted
            let sameEvent ;
            if (element[day] && element.events) {

                // element.events.forEach(blub=>{
                //     if(day in blub.logged){
                //         inArray = true;
                //         sameEvent = blub;
                //     }
                // })
                


                // let sameEvent = element.events.map(dayEvent => (day in dayEvent.logged ? dayEvent:0));

                sameEvent = element.events.filter(blub => (day in blub.logged))[0];
                


                if ( sameEvent && (checkHoures(element, sameEvent, day) || checkComment(element, sameEvent) || checkTaskID(element, sameEvent))) {
                    // this thould be the update part 
                    let tempEvent = sameEvent;
                    delete tempEvent.logged;
                    tempEvent.time_stop = addhoures(tempEvent.time_start, element[day]);
                    if (element.comment) {
                        tempEvent.comment = element.comment;
                    }
                    update_events_send.push(tempEvent);
                    inArray = true;

                } else {
                    console.log("the same");

                }

                inArray = true;
            }


            if ( !inArray && element[day]) { // it is new event
                // * new event
                let newEvent = {
                    user_id: user_id,
                    task_id: element.task_id,
                    time_start: week[day].getTime(),
                    time_stop: addhoures(week[day], element[day])
                };

                if (element.comment) {
                    newEvent['comment'] = element.comment;
                }
                create_events_send.push(newEvent);
            }
    


        }))
    });




console.log("create_events_send:  ", create_events_send);
console.log("update_events_send:  ", update_events_send);



exit()

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





for (let houreevent of save_data) {
    for (let day of weekdays) {
        // if (event_list.length) break;

        for (let event_ of event_list) {

            if ((houreevent[day + "_id"] && event_._id === houreevent[day + "_id"])) {

                // if(houreevent[day + "_id"] && event_.task_id !== houreevent.task_id)


                let task_id_temp = get_task_id(houreevent.projectSel, houreevent.taskSel);
                if (houreevent[day] == new_houres(event_.time_start, event_.time_stop) && (houreevent.comment && houreevent.comment === event_.comment && task_id_temp === houreevent.task_id)) {
                    // console.log("no update needed: ", day, ", ", new_houres);
                    // if same houres dont update 
                } else {
                    let element = {
                        user_id: user_id,
                        task_id: task_id_temp,
                        time_start: week[day].getTime(),
                        time_stop: addhoures(week[day], houreevent[day]),
                        _id: houreevent[day + "_id"]
                    };

                    if (houreevent.comment) {
                        element['comment'] = houreevent.comment;
                    }

                    update_events_send.push(element)
                }
            }// end if houreevent
        }



        if (!houreevent[day + "_id"] && houreevent[day]) {

            let task_id = houreevent.task_id;
            if (!task_id) {
                task_id = get_task_id(houreevent.projectSel, houreevent.taskSel)
            }

            // check if its not zero or undefined
            let element = {
                user_id: user_id,
                task_id: task_id,
                time_start: week[day].getTime(),
                time_stop: addhoures(week[day], houreevent[day])

            };

            if (houreevent.comment) {
                element['comment'] = houreevent.comment;
            }

            create_events_send.push(element);
        }
    }
}


// TODO: write part when error return or saved flag

if (create_events_send.length) {
    dataPrikklok.event_create_post(create_events_send).subscribe(data => console.log(data));
}


update_events_send.forEach(element => {
    dataPrikklok.event_create_put(element).subscribe();
});


// update();
